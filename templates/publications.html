{% extends "base.html" %}

{% macro sort_link(field_name, display_name) %}
    {% set is_current = (current_sort == field_name) %}
    {% set order_to_use = reverse_order if is_current else 'desc' %}

    <a href="{{ url_for('publications',
                        source=request.args.get('source', ''),
                        date_from=request.args.get('date_from', ''),
                        date_to=request.args.get('date_to', ''),
                        sentiment=request.args.get('sentiment', 'all'),
                        source_type=request.args.get('source_type', 'all'),
                        mau_only='on' if request.args.get('mau_only') == 'on' else '',
                        sort=field_name,
                        order=order_to_use) }}">
        {{ display_name }}
        {% if is_current %}
            {% if current_order == 'asc' %}▲{% else %}▼{% endif %}
        {% endif %}
    </a>
{% endmacro %}

{% block content %}
<h1>Публикации</h1>

<form method="get" class="mb-4">
    <div class="row g-3">
        <div class="col-md-3">
            <label for="source" class="form-label">Источник</label>
            <input type="text" class="form-control" id="source" name="source" 
                   value="{{ request.args.get('source', '') }}" list="sourceOptions" autocomplete="off">
            <datalist id="sourceOptions">
                {% for source in all_sources %}
                <option value="{{ source.sname }}">{{ source.sname }}</option>
                {% endfor %}
            </datalist>
        </div>

        <div class="col-md-2">
            <label for="date_from" class="form-label">Дата от</label>
            <input type="date" class="form-control" id="date_from" name="date_from"
                   value="{{ request.args.get('date_from', '') }}">
        </div>

        <div class="col-md-2">
            <label for="date_to" class="form-label">Дата до</label>
            <input type="date" class="form-control" id="date_to" name="date_to"
                   value="{{ request.args.get('date_to', '') }}">
        </div>

        <div class="col-md-2">
            <label for="sentiment" class="form-label">Тональность</label>
            <select class="form-select" id="sentiment" name="sentiment">
                <option value="all">Все</option>
                <option value="positive" {% if request.args.get('sentiment') == 'positive' %}selected{% endif %}>Позитивные</option>
                <option value="negative" {% if request.args.get('sentiment') == 'negative' %}selected{% endif %}>Негативные</option>
                <option value="neutral" {% if request.args.get('sentiment') == 'neutral' %}selected{% endif %}>Нейтральные</option>
            </select>
        </div>

        <div class="col-md-3">
            <label for="source_type" class="form-label">Тип источника</label>
            <select class="form-select" id="source_type" name="source_type">
                <option value="all">Все</option>
                <option value="vk" {% if request.args.get('source_type') == 'vk' %}selected{% endif %}>ВКонтакте</option>
                <option value="tg" {% if request.args.get('source_type') == 'tg' %}selected{% endif %}>Телеграм</option>
                <option value="website" {% if request.args.get('source_type') == 'website' %}selected{% endif %}>Веб-сайты</option>
            </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="mau_only" name="mau_only"
                       {% if request.args.get('mau_only') == 'on' %}checked{% endif %}>
                <label class="form-check-label" for="mau_only">С упоминанием</label>
            </div>
        </div>

        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">Фильтровать</button>
        </div>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>{{ sort_link('pdate', 'Дата') }}</th>
                <th>Источник</th>
                <th>Тип</th>
                <th>Тональность</th>
                <th>Упоминание</th>
                <th>{{ sort_link('views', 'Просмотры') }}</th>
                <th>{{ sort_link('likes', 'Лайки') }}</th>
                <th>{{ sort_link('comments', 'Комментарии') }}</th>
                <th>{{ sort_link('reposts', 'Репосты') }}</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for pub in publications %}
            <tr>
                <td>{{ pub.pdate.strftime('%d.%m.%Y') }}</td>
                <td>{{ pub.source.sname }}</td>
                <td>
                    {% if pub.source.source_type == 'vk' %}
                        <img src="{{ url_for('static', filename='icons/vk.png') }}" alt="vk" width="24">
                    {% elif pub.source.source_type == 'tg' %}
                        <img src="{{ url_for('static', filename='icons/telegram.png') }}" alt="telegram" width="24">
                    {% elif pub.source.source_type == 'website' %}
                        <img src="{{ url_for('static', filename='icons/web.png') }}" alt="website" width="24">
                    {% endif %}
                </td>
                <td>
                    <span class="badge 
                        {% if pub.assesment == 'positive' %}bg-success
                        {% elif pub.assesment == 'negative' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ pub.assesment }}
                    </span>
                </td>
                <td>
                    {% if pub.mau_mentioned %}
                        <span class="badge bg-primary">Да</span>
                    {% else %}
                        <span class="badge bg-secondary">Нет</span>
                    {% endif %}
                </td>
                <td>{{ "{:,}".format(pub.views).replace(",", " ") if pub.views else 0 }}</td>
                <td>{{ "{:,}".format(pub.likes).replace(",", " ") if pub.likes else 0 }}</td>
                <td>{{ "{:,}".format(pub.comments).replace(",", " ") if pub.comments else 0 }}</td>
                <td>{{ "{:,}".format(pub.reposts).replace(",", " ") if pub.reposts else 0 }}</td>
                <td>
                    <a href="/publication/{{ pub.pid }}" class="btn btn-sm btn-outline-primary">Подробнее</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
